# -------------------------------------------------
# src/pixel/pixel_manager.py
"""
PixelManager: gestisce un insieme di "pixel" biologici in modo
data‑oriented. È pensato per essere semplice da leggere ed estendere.

Punti chiave rispetto al modello evolutivo che vogliamo:

- Tutte le unità iniziali sono quasi identiche e *prive* di tratti
  avanzati: nessuna motilità attiva, nessuna capacità di replicazione
  affidabile garantita.
- La motilità è un *tratto genetico*: senza un gene di motilità sopra
  soglia, il movimento è quasi nullo e puramente passivo (vento/jitter).
- La riproduzione 1→2 è costosa e opzionale: richiede sia un gene di
  replicazione sia scorte interne sufficienti, con mutazioni sul genoma.
"""
from typing import List, Tuple, Optional, Dict
import importlib
import importlib.util
import math

import numpy as np

from .pixel import Pixel


def _module_exists(module_name: str) -> bool:
    return importlib.util.find_spec(module_name) is not None


class PixelManager:
    def __init__(self, capacity: int = 1024):
        # storage di base
        self.capacity = capacity
        self.count = 0
        self.positions = np.zeros((capacity, 2), dtype=np.float32)
        self.energies = np.ones((capacity,), dtype=np.float32)
        self.stamina = np.ones((capacity,), dtype=np.float32)
        self.alive = np.ones((capacity,), dtype=np.bool_)
        self.time = 0.0

        # birth timestamps (in simulation time) per età di linea
        self.birth_time = np.zeros((capacity,), dtype=np.float32)
        # storia energetica lenta per segnali di omeostasi
        self._energy_avg = np.ones((capacity,), dtype=np.float32)
        self._energy_var = np.zeros((capacity,), dtype=np.float32)

        # identità di "specie" emergente (inizialmente tutte uguali)
        self.species: List[str] = ["proto"] * capacity

        # moduli opzionali
        self.genomes: List[Optional[object]] = [None] * capacity
        # tratti evolutivi decodificati dal genoma (skill attive)
        self.traits: List[set] = [set() for _ in range(capacity)]
        self.internal_resources = None

        self.has_genome = _module_exists("pixel.genome")
        self.has_metabolism = _module_exists("pixel.metabolism")
        self.has_reproduction = _module_exists("pixel.reproduction")

